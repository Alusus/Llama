اشمل "مـتم/طـرفية"؛
اشمل "مـتم/نـم"؛
اشمل "مـتم/نـص"؛
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Ggml"، "جـجمل.أسس")؛
مـحا.اشمل_ملف("Alusus/Llama"، "لـاما.أسس")؛
استخدم مـتم؛
استخدم لـاما؛

// نزل النموذج من https://huggingface.co/QuantFactory/jais-adapted-7b-chat-GGUF/blob/main/jais-adapted-7b-chat.Q4_K_M.gguf
// نموذج Jais مُحسَّن للغة العربية

جـجمل.مـشغل.حمل_للمعالج()؛
جـجمل.مـشغل.حمل_لفلكان()؛

عرف نموذج: سند[نـموذج](نـموذج.حمل("jais-adapted-7b-chat.Q4_K_M.gguf"، نـموذج.هات_معطيات_افتراضية()))؛
إذا نموذج~مؤشر == 0 {
    طـرفية.اطبع("\nخطأ في تحميل النموذج\n")؛
} وإلا {
    عرف سياق: سند[سـياق](سـياق.هيئ_من_نموذج(نموذج، سـياق.هات_معطيات_افتراضية()))؛
    إذا سياق~مؤشر == 0 {
        طـرفية.اطبع("خطأ في تهيئة السياق\n")؛
        نـموذج.حرر(نموذج)؛
    } وإلا {
        طـرفية.اطبع("=== البداية ===\n")؛
        طـرفية.اطبع(
            "هذا مثال على الإكمال التلقائي باستخدام نموذج Jais المُحسَّن للعربية. "
            "أدخل سؤالاً أو تعليمة بالعربية أو الإنجليزية.\n"
        )؛
        طـرفية.اطبع("موجهك: ")؛
        عرف إدخال_المستخدم: مصفوفة[محرف، 1024]؛
        طـرفية.أدخل_محارف(إدخال_المستخدم~مؤشر، إدخال_المستخدم~حجم)؛
        // تجهيز الموجه بقالب Jais للمحادثة
        عرف موجه: مصفوفة[محرف، 2048]؛
        نـص.عين(موجه~مؤشر، "### Instruction: %s\n\n### Response:"، إدخال_المستخدم~مؤشر)؛
        عرف رموز: مصفوفة[رمـز، 512]؛
        عرف عدد_الرموز: صـحيح = رمز(نموذج.المفردات، موجه~مؤشر، نـص.هات_الطول(موجه~مؤشر)، رموز، 512، 1، 1)؛
        إذا عدد_الرموز < 0 {
            طـرفية.اطبع("خطأ في الترميز\n")؛
            سـياق.حرر(سياق)؛
            نـموذج.حرر(نموذج)؛
        } وإلا {
            عرف دفعة: دفـعة = دفـعة.هات_واحدا(رموز، عدد_الرموز)؛
            إذا سياق.فك_ترميز(دفعة) != 0 {
                طـرفية.اطبع("خطأ في فك الترميز\n")؛
                سـياق.حرر(سياق)؛
                نـموذج.حرر(نموذج)؛
            } وإلا {
                // إنشاء سلسلة معاينات مع عقوبات، أعلى-ك، أعلى-ب، والمعاينة العشوائية
                عرف معطيات_السلسلة: مـعاين.مـعطيات_سلسلة؛
                معطيات_السلسلة.بلا_أداء = 1؛
                عرف معاين: سند[مـعاين](مـعاين.هيئ_سلسلة(معطيات_السلسلة))؛
                // عقوبة التكرار: معاقبة آخر 64 رمزاً، عقوبة التكرار 1.15 (أعلى لتجنب التكرار بالعربية)
                معاين.أضف_للسلسلة(مـعاين.هيئ_جزاءات(64، 1.15، 0.0، 0.0))؛
                // زيادة top_k و top_p للسماح بتنوع أكبر مع اللغة العربية
                معاين.أضف_للسلسلة(مـعاين.هيئ_أعلى_ع(50))؛
                معاين.أضف_للسلسلة(مـعاين.هيئ_أعلى_ن(0.9، 1))؛
                معاين.أضف_للسلسلة(مـعاين.هيئ_منتشر(0))؛
                طـرفية.اطبع("=== المخرجات ===\n")؛
                طـرفية.اطبع("%s "، موجه~مؤشر)؛
                عرف رموز_مولدة: مصفوفة[رمـز، 512]؛
                عرف عدد_المولدة: صحيح = 0؛
                عرف الطول_السابق: صحيح = 0؛
                عرف ع: صحيح = 0؛
                بينما ع < 500 {
                    عرف معرف: مصفوفة[رمـز، 1]؛
                    معرف(0) = معاين.عاين(سياق، -1)؛
                    إذا نموذج.المفردات.أهي_نهاية_التوليد(معرف(0)) اقطع؛
                    // رموز توقف Jais: نهاية التسلسل (EOS=2) ورمز التعبئة (PAD=0)
                    إذا معرف(0) == 2 || معرف(0) == 0 اقطع؛
                    رموز_مولدة(عدد_المولدة) = معرف(0)؛
                    ++عدد_المولدة؛
                    // فك ترميز جميع الرموز معاً للحصول على المسافات الصحيحة
                    // زيادة حجم الصوان للنص العربي (UTF-8 يستخدم بايتات أكثر)
                    عرف صوان: مصفوفة[محرف، 8192]؛
                    عرف ن: صحيح = فك_ترميز(نموذج.المفردات، رموز_مولدة، عدد_المولدة، صوان~مؤشر، 8000، 0، 0)؛
                    إذا ن > الطول_السابق {
                        // اطبع الأحرف الجديدة فقط
                        صوان(ن) = 0؛
                        طـرفية.اطبع("%s"، صوان(الطول_السابق)~مؤشر)؛
                        الطول_السابق = ن؛
                    }
                    عرف الدفعة_التالية: دفـعة = دفـعة.هات_واحدا(معرف، 1)؛
                    إذا سياق.فك_ترميز(الدفعة_التالية) != 0 {
                        طـرفية.اطبع("\nخطأ في توليد الرمز التالي\n")؛
                        اقطع؛
                    }
                    نـم.اطلق(0)؛
                    ++ع؛
                }
                طـرفية.اطبع("\n==============\n")؛
                مـعاين.حرر(معاين)؛
                سـياق.حرر(سياق)؛
                نـموذج.حرر(نموذج)؛
            }
        }
    }
}
