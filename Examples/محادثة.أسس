اشمل "مـتم/طـرفية"؛
اشمل "مـتم/نـم"؛
اشمل "مـتم/نـص"؛
اشمل "مـتم/مـصفوفة"؛
اشمل "مـتم/ذاكـرة"؛
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Ggml"، "جـجمل.أسس")؛
مـحا.اشمل_ملف("Alusus/Llama"، "لـاما.أسس")؛
استخدم مـتم؛
استخدم لـاما؛

// نزل النموذج من https://huggingface.co/QuantFactory/jais-adapted-7b-chat-GGUF/blob/main/jais-adapted-7b-chat.Q4_K_M.gguf
// نموذج Jais مُحسَّن للغة العربية

جـجمل.مـشغل.حمل_للمعالج()؛
جـجمل.مـشغل.حمل_لفلكان()؛

عرف نموذج: سند[نـموذج](نـموذج.حمل("jais-adapted-7b-chat.Q4_K_M.gguf"، نـموذج.هات_معطيات_افتراضية()))؛
إذا نموذج~مؤشر == 0 {
    طـرفية.اطبع("\nخطأ في تحميل النموذج\n")؛
} وإلا {
    // زيادة حجم السياق للمحادثات الطويلة
    عرف معطيات_السياق: سـياق.مـعطيات = سـياق.هات_معطيات_افتراضية()؛
    معطيات_السياق.رقم_السياق = 2048؛
    عرف سياق: سند[سـياق](سـياق.هيئ_من_نموذج(نموذج، معطيات_السياق))؛
    إذا سياق~مؤشر == 0 {
        طـرفية.اطبع("خطأ في تهيئة السياق\n")؛
        نـموذج.حرر(نموذج)؛
    } وإلا {
        // إنشاء سلسلة معاينات مع عقوبات لتجنب التكرار
        عرف معطيات_السلسلة: مـعاين.مـعطيات_سلسلة؛
        معطيات_السلسلة.بلا_أداء = 1؛
        عرف معاين: سند[مـعاين](مـعاين.هيئ_سلسلة(معطيات_السلسلة))؛
        معاين.أضف_للسلسلة(مـعاين.هيئ_جزاءات(64، 1.15، 0.0، 0.0))؛
        معاين.أضف_للسلسلة(مـعاين.هيئ_أعلى_ع(50))؛
        معاين.أضف_للسلسلة(مـعاين.هيئ_أعلى_ن(0.9، 1))؛
        معاين.أضف_للسلسلة(مـعاين.هيئ_منتشر(0))؛

        // تخزين سجل المحادثة
        عرف رسائل: مـصفوفة[رسـالة_محادثة]؛
        عرف محتويات_الرسائل: مـصفوفة[نـص]؛  // إبقاء النصوص حية

        طـرفية.اطبع("=== محادثة Jais ===\n")؛
        طـرفية.اطبع("هذا مثال على المحادثة باستخدام نموذج Jais المُحسَّن للعربية.\n")؛
        طـرفية.اطبع("اكتب رسالتك واضغط Enter. اكتب 'خروج' للإنهاء.\n\n")؛

        بينما 1 {
            طـرفية.اطبع("أنت: ")؛
            نـم.اطلق(0)؛

            // قراءة إدخال المستخدم
            عرف صوان_الإدخال: مصفوفة[محرف، 1024]؛
            طـرفية.أدخل_محارف(صوان_الإدخال~مؤشر، صوان_الإدخال~حجم)؛

            عرف إدخال_المستخدم: نـص(صوان_الإدخال~مؤشر)؛
            إذا إدخال_المستخدم == "خروج" || إدخال_المستخدم == "quit" || إدخال_المستخدم == "exit" اقطع؛
            إذا إدخال_المستخدم.هات_الطول() == 0 أكمل؛

            // إضافة رسالة المستخدم إلى السجل
            محتويات_الرسائل.أضف(إدخال_المستخدم)؛
            عرف رسالة_المستخدم: رسـالة_محادثة؛
            رسالة_المستخدم.الدور = "user"؛
            رسالة_المستخدم.المحتوى = محتويات_الرسائل(محتويات_الرسائل.هات_الطول() - 1).صوان؛
            رسائل.أضف(رسالة_المستخدم)؛

            // تطبيق قالب المحادثة
            عرف صوان_القالب: مصفوفة[محرف، 8192]؛
            عرف طول_القالب: صـحيح = طبق_قالب_محادثة(
                0،  // استخدام قالب النموذج الافتراضي
                رسائل.صوان، رسائل.هات_الطول()،
                1،  // إضافة موجه المساعد
                صوان_القالب~مؤشر، 8192
            )؛

            إذا طول_القالب < 0 {
                طـرفية.اطبع("خطأ في تطبيق قالب المحادثة\n")؛
                أكمل؛
            }

            // ترميز الموجه المنسق
            عرف رموز: مصفوفة[رمـز، 2048]؛
            عرف عدد_الرموز: صـحيح = رمز(نموذج.المفردات، صوان_القالب~مؤشر، طول_القالب، رموز، 2048، 1، 1)؛
            إذا عدد_الرموز < 0 {
                طـرفية.اطبع("خطأ في الترميز\n")؛
                أكمل؛
            }

            // فك ترميز رموز الموجه
            عرف دفعة: دفـعة = دفـعة.هات_واحدا(رموز، عدد_الرموز)؛
            إذا سياق.فك_ترميز(دفعة) != 0 {
                // قد يكون السياق ممتلئاً، محاولة مسح الذاكرة وإعادة المحاولة
                طـرفية.اطبع("[السياق ممتلئ، جارٍ مسح السجل...]\n")؛
                سياق.هات_الذاكرة()~محتوى.صفر(1)؛
                رسائل.فرغ()؛
                محتويات_الرسائل.فرغ()؛
                // إعادة إضافة الرسالة الحالية فقط
                محتويات_الرسائل.أضف(إدخال_المستخدم)؛
                عرف رسالة_جديدة: رسـالة_محادثة؛
                رسالة_جديدة.الدور = "user"؛
                رسالة_جديدة.المحتوى = محتويات_الرسائل(0).صوان؛
                رسائل.أضف(رسالة_جديدة)؛
                // إعادة تطبيق القالب والترميز
                طول_القالب = طبق_قالب_محادثة(0، رسائل.صوان، رسائل.هات_الطول()، 1، صوان_القالب~مؤشر، 8192)؛
                عدد_الرموز = رمز(نموذج.المفردات، صوان_القالب~مؤشر، طول_القالب، رموز، 2048، 1، 1)؛
                دفعة = دفـعة.هات_واحدا(رموز، عدد_الرموز)؛
                إذا سياق.فك_ترميز(دفعة) != 0 {
                    طـرفية.اطبع("خطأ في فك ترميز الموجه\n")؛
                    أكمل؛
                }
            }

            // توليد الرد
            طـرفية.اطبع("المساعد: ")؛
            عرف رموز_مولدة: مصفوفة[رمـز، 512]؛
            عرف عدد_المولدة: صـحيح = 0؛
            عرف الطول_الآمن: صـحيح = 0؛      // طول النص المؤكد أنه آمن للطباعة
            عرف الطول_المطبوع: صـحيح = 0؛   // طول النص المطبوع بالفعل
            عرف وصلنا_لتسلسل_التوقف: ثـنائي = خطأ؛
            عرف نوع_آخر_علامة_ترقيم: محرف = 0؛  // تتبع آخر علامة ترقيم (. ! ?)

            عرف ع: صـحيح = 0؛
            بينما ع < 256 {
                عرف معرف: مصفوفة[رمـز، 1]؛
                معرف(0) = معاين.عاين(سياق، -1)؛

                // التحقق من نهاية التوليد
                إذا نموذج.المفردات.أهي_نهاية_التوليد(معرف(0)) اقطع؛
                // رموز توقف Jais
                إذا معرف(0) == 2 || معرف(0) == 0 اقطع؛

                // التحقق مما إذا كان هذا الرمز رمز تحكم
                عرف صوان_الرمز: مصفوفة[محرف، 128]؛
                عرف طول_الرمز: صـحيح = فك_ترميز(نموذج.المفردات، معرف، 1، صوان_الرمز~مؤشر، 128، 0، 0)؛
                إذا طول_الرمز > 0 {
                    صوان_الرمز(طول_الرمز) = 0؛
                    عرف نص_الرمز: نـص(صوان_الرمز~مؤشر)؛
                    // إذا بدأ هذا الرمز تسلسل تحكم، توقف قبل إضافته
                    إذا نص_الرمز.جد("<|") != -1 || نص_الرمز.جد("</s>") != -1 {
                        وصلنا_لتسلسل_التوقف = 1؛
                        اقطع؛
                    }
                }

                رموز_مولدة(عدد_المولدة) = معرف(0)؛
                ++عدد_المولدة؛

                // فك ترميز جميع الرموز معاً للحصول على المسافات الصحيحة
                عرف صوان: مصفوفة[محرف، 8192]؛
                عرف ن: صـحيح = فك_ترميز(نموذج.المفردات، رموز_مولدة، عدد_المولدة، صوان~مؤشر، 8000، 0، 0)؛
                صوان(ن) = 0؛

                // التحقق من تسلسلات التوقف في النص المتراكم
                عرف النص_الحالي: نـص(صوان~مؤشر)؛
                عرف موضع_التوقف: صـحيح = النص_الحالي.جد("<|")؛
                إذا موضع_التوقف == -1 موضع_التوقف = النص_الحالي.جد("</s>")؛

                إذا موضع_التوقف != -1 {
                    // وجدنا تسلسل توقف - اطبع فقط حتى هنا
                    الطول_الآمن = موضع_التوقف؛
                    وصلنا_لتسلسل_التوقف = 1؛
                    اقطع؛
                }

                // التحقق من سطرين جديدين - غالباً يشير إلى أن النموذج يحاول بدء دور جديد
                عرف سطران_جديدان: صـحيح = النص_الحالي.جد("\n\n")؛
                إذا سطران_جديدان != -1 && سطران_جديدان > 20 {
                    // توقف عند السطرين الجديدين
                    الطول_الآمن = سطران_جديدان؛
                    وصلنا_لتسلسل_التوقف = 1؛
                    اقطع؛
                }

                // إيجاد آخر نقطة آمنة (نهاية جملة)
                عرف ي: صـحيح = ن - 1؛
                بينما ي > الطول_الآمن {
                    عرف ح: محرف = صوان(ي)؛
                    إذا (ح == '.' || ح == '!' || ح == '?') && ي > 0 {
                        // التأكد من أنها ليست نقطة عشرية أو اختصار
                        عرف السابق: محرف = صوان(ي - 1)؛
                        إذا السابق >= '0' && السابق <= '9' {
                            // غالباً عشرية، تخطي
                            --ي؛
                            أكمل؛
                        }

                        // إذا كان لدينا بالفعل نهاية جملة (.) والآن نرى سؤالاً (?)،
                        // هذا غالباً النموذج يهلوس سؤال متابعة - توقف هنا
                        إذا ح == '?' && نوع_آخر_علامة_ترقيم == '.' && الطول_الآمن > 0 {
                            وصلنا_لتسلسل_التوقف = 1؛
                            اقطع؛
                        }

                        // إذا في نهاية الصوان أو متبوع بمسافة، فهي نقطة آمنة
                        عرف نقطة_آمنة: ثـنائي = خطأ؛
                        إذا ي + 1 >= ن {
                            نقطة_آمنة = 1؛
                        } وإلا {
                            عرف التالي: محرف = صوان(ي + 1)؛
                            إذا التالي == ' ' || التالي == '\n' || التالي == '\r' {
                                نقطة_آمنة = 1؛
                            }
                        }

                        إذا نقطة_آمنة {
                            الطول_الآمن = ي + 1؛
                            نوع_آخر_علامة_ترقيم = ح؛
                            اقطع؛
                        }
                    }
                    --ي؛
                }

                // الخروج من الحلقة الرئيسية إذا اكتشفنا هلوسة
                إذا وصلنا_لتسلسل_التوقف اقطع؛

                // طباعة النص الآمن
                إذا الطول_الآمن > الطول_المطبوع {
                    عرف صوان_الطباعة: مصفوفة[محرف، 8192]؛
                    ذاكـرة.انسخ(صوان_الطباعة~مؤشر، صوان~مؤشر، الطول_الآمن)؛
                    صوان_الطباعة(الطول_الآمن) = 0؛
                    طـرفية.اطبع("%s"، صوان_الطباعة(الطول_المطبوع)~مؤشر)؛
                    الطول_المطبوع = الطول_الآمن؛
                }

                // تحضير الدفعة التالية
                عرف الدفعة_التالية: دفـعة = دفـعة.هات_واحدا(معرف، 1)؛
                إذا سياق.فك_ترميز(الدفعة_التالية) != 0 {
                    طـرفية.اطبع("\nخطأ في التوليد\n")؛
                    اقطع؛
                }

                نـم.اطلق(0)؛
                ++ع؛
            }

            // طباعة أي نص متبقٍ حتى الطول_الآمن لم يُطبع بعد
            إذا عدد_المولدة > 0 {
                عرف الصوان_النهائي: مصفوفة[محرف، 8192]؛
                عرف الطول_النهائي: صـحيح = فك_ترميز(نموذج.المفردات، رموز_مولدة، عدد_المولدة، الصوان_النهائي~مؤشر، 8000، 0، 0)؛
                الصوان_النهائي(الطول_النهائي) = 0؛

                // تحديد الطول الآمن النهائي للطباعة/التخزين
                عرف الطول_الآمن_النهائي: صـحيح = الطول_الآمن؛
                إذا !وصلنا_لتسلسل_التوقف {
                    // إذا لم نصل لتسلسل توقف، اشمل كل النص المولد
                    الطول_الآمن_النهائي = الطول_النهائي؛
                } وإلا إذا الطول_الآمن_النهائي == 0 && الطول_النهائي > 0 {
                    // إذا الطول_الآمن هو 0 لكن لدينا نص، استخدم كله حتى أي توقف
                    عرف نص_مؤقت: نـص(الصوان_النهائي~مؤشر)؛
                    عرف توقف_عند: صـحيح = نص_مؤقت.جد("<|")؛
                    إذا توقف_عند == -1 توقف_عند = نص_مؤقت.جد("</s>")؛
                    إذا توقف_عند == -1 توقف_عند = نص_مؤقت.جد("\n\n")؛
                    إذا توقف_عند != -1 الطول_الآمن_النهائي = توقف_عند وإلا الطول_الآمن_النهائي = الطول_النهائي؛
                }

                // طباعة أي نص متبقٍ
                إذا الطول_الآمن_النهائي > الطول_المطبوع {
                    عرف المتبقي: مصفوفة[محرف، 8192]؛
                    ذاكـرة.انسخ(المتبقي~مؤشر، الصوان_النهائي~مؤشر، الطول_الآمن_النهائي)؛
                    المتبقي(الطول_الآمن_النهائي) = 0؛
                    طـرفية.اطبع("%s"، المتبقي(الطول_المطبوع)~مؤشر)؛
                }

                // تخزين الرد النظيف في السجل
                إذا الطول_الآمن_النهائي > 0 {
                    الصوان_النهائي(الطول_الآمن_النهائي) = 0؛
                    عرف الرد_النظيف: نـص(الصوان_النهائي~مؤشر)؛
                    // إزالة المسافات البيضاء من النهاية
                    بينما الرد_النظيف.هات_الطول() > 0 {
                        عرف آخر_حرف: محرف = الرد_النظيف(الرد_النظيف.هات_الطول() - 1)؛
                        إذا آخر_حرف == ' ' || آخر_حرف == '\n' || آخر_حرف == '\r' || آخر_حرف == '\t' {
                            الرد_النظيف = الرد_النظيف.اجتزئ(0، الرد_النظيف.هات_الطول() - 1)؛
                        } وإلا {
                            اقطع؛
                        }
                    }

                    إذا الرد_النظيف.هات_الطول() > 0 {
                        محتويات_الرسائل.أضف(الرد_النظيف)؛
                        عرف رسالة_المساعد: رسـالة_محادثة؛
                        رسالة_المساعد.الدور = "assistant"؛
                        رسالة_المساعد.المحتوى = محتويات_الرسائل(محتويات_الرسائل.هات_الطول() - 1).صوان؛
                        رسائل.أضف(رسالة_المساعد)؛
                    }
                }
            }

            طـرفية.اطبع("\n\n")؛
            معاين.صفر()؛
        }

        طـرفية.اطبع("\nمع السلامة!\n")؛
        مـعاين.حرر(معاين)؛
        سـياق.حرر(سياق)؛
        نـموذج.حرر(نموذج)؛
    }
}
